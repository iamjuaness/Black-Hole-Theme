# GitHub Actions Workflow for automatic release after Build completes
# This workflow creates and publishes a release automatically when Build succeeds on main branch

name: Release
on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
    branches:
      - main

jobs:
  # Check if the workflow run was successful and not a PR
  check:
    name: Check Build Status
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event != 'pull_request' }}
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Check if release draft exists
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(grep "^pluginVersion" gradle.properties | cut -d'=' -f2 | tr -d ' ')
          echo "Checking for draft release v$VERSION"
          
          DRAFT_EXISTS=$(gh api repos/{owner}/{repo}/releases --jq ".[] | select(.draft == true and .tag_name == \\"v$VERSION\\") | .id")
          
          if [ -n "$DRAFT_EXISTS" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Draft release found, will publish"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "No draft release found, skipping"
          fi

      - name: Get Version
        id: version
        run: |
          VERSION=$(grep "^pluginVersion" gradle.properties | cut -d'=' -f2 | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # Publish the draft release created by Build workflow
  publish:
    name: Publish Release
    needs: check
    if: ${{ needs.check.outputs.should_release == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Get Release Notes
        id: notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          NOTES=$(gh api repos/{owner}/{repo}/releases/tags/v$VERSION --jq '.body')
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Publish Plugin to JetBrains Marketplace
        env:
          PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
          CERTIFICATE_CHAIN: ${{ secrets.CERTIFICATE_CHAIN }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PRIVATE_KEY_PASSWORD: ${{ secrets.PRIVATE_KEY_PASSWORD }}
        run: ./gradlew publishPlugin

      - name: Publish GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          gh release edit v$VERSION --draft=false

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          gh release upload v$VERSION ./build/distributions/* --clobber

      - name: Patch Changelog
        if: ${{ steps.notes.outputs.changelog != '' }}
        env:
          CHANGELOG: ${{ steps.notes.outputs.changelog }}
        run: |
          ./gradlew patchChangelog --release-note="$CHANGELOG"

      - name: Create Pull Request
        if: ${{ steps.notes.outputs.changelog != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="v${{ needs.check.outputs.version }}"
          BRANCH="changelog-update-$VERSION"
          LABEL="release changelog"

          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git checkout -b $BRANCH
          git commit -am "Changelog update - $VERSION"
          git push --set-upstream origin $BRANCH
          
          gh label create "$LABEL" \\
            --description "Pull requests with release changelog update" \\
            --force \\
            || true

          gh pr create \\
            --title "Changelog update - \\`$VERSION\\`" \\
            --body "Current pull request contains patched \\`CHANGELOG.md\\` file for the \\`$VERSION\\` version." \\
            --label "$LABEL" \\
            --head $BRANCH